<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Care Notes - Customer Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-healthy { @apply bg-green-100 text-green-800 border-green-200; }
        .status-unhealthy { @apply bg-red-100 text-red-800 border-red-200; }
        .status-treated { @apply bg-blue-100 text-blue-800 border-blue-200; }
        
        .image-preview {
            position: relative;
            display: inline-block;
            margin: 0.25rem;
        }
        
        .image-preview img {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
        }
        
        .image-preview .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .image-gallery img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .image-gallery img:hover {
            transform: scale(1.05);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }
        
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            margin-top: 2%;
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #bbb;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .manage-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .manage-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .existing-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .existing-image {
            position: relative;
            display: inline-block;
        }

        .existing-image img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 0.375rem;
            border: 2px solid #e5e7eb;
            cursor: pointer;
        }

        .existing-image .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Plant Care Notes</h1>
            <p class="text-gray-600">Customer Management System for Plant Care Professionals</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button onclick="showTab('customers')" id="customers-tab" 
                            class="py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200 border-blue-500 text-blue-600">
                        Customers
                    </button>
                    <button onclick="showTab('notes')" id="notes-tab" 
                            class="py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Plant Notes
                    </button>
                </nav>
            </div>

            <!-- Customers Tab Content -->
            <div id="customers-content" class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Customer Management</h2>
                    <button onclick="showAddCustomerForm()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Add New Customer
                    </button>
                </div>

                <!-- Add Customer Form (Hidden by default) -->
                <div id="add-customer-form" class="hidden bg-gray-50 rounded-lg p-6 mb-6 border border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Customer</h3>
                    <form onsubmit="addCustomer(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                            <input type="text" id="customer-name" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="customer-email" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                            <input type="tel" id="customer-phone" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <input type="text" id="customer-address" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="md:col-span-2 flex gap-3">
                            <button type="submit" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                                Add Customer
                            </button>
                            <button type="button" onclick="hideAddCustomerForm()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Customers List -->
                <div id="customers-list" class="space-y-4">
                    <!-- Customers will be loaded here -->
                </div>
            </div>

            <!-- Notes Tab Content -->
            <div id="notes-content" class="p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Plant Care Notes</h2>
                    <button onclick="showAddNoteForm()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Add New Note
                    </button>
                </div>

                <!-- Filters -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Customer</label>
                            <select id="filter-customer" onchange="filterNotes()" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All Customers</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                            <select id="filter-status" onchange="filterNotes()" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All Statuses</option>
                                <option value="healthy">Healthy</option>
                                <option value="unhealthy">Unhealthy</option>
                                <option value="treated">Treated</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="clearFilters()" 
                                    class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add Note Form (Hidden by default) -->
                <div id="add-note-form" class="hidden bg-gray-50 rounded-lg p-6 mb-6 border border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Plant Note</h3>
                    <form onsubmit="addNote(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4" enctype="multipart/form-data">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Customer *</label>
                            <select id="note-customer" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Customer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Plant/Tree Name *</label>
                            <input type="text" id="note-plant-name" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Condition *</label>
                            <textarea id="note-condition" required rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Recommended Treatment *</label>
                            <textarea id="note-treatment" required rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                            <select id="note-status" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Status</option>
                                <option value="healthy">Healthy</option>
                                <option value="unhealthy">Unhealthy</option>
                                <option value="treated">Treated</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Images</label>
                            <input type="file" id="note-images" multiple accept="image/*" 
                                   onchange="previewImages(this)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Select multiple images (PNG, JPG, JPEG, GIF, WebP). Max 16MB per file.</p>
                            <div id="image-preview-container" class="mt-3"></div>
                        </div>
                        <div class="md:col-span-2 flex gap-3">
                            <button type="submit" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                                Add Note
                            </button>
                            <button type="button" onclick="hideAddNoteForm()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Notes List -->
                <div id="notes-list" class="space-y-4">
                    <!-- Notes will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <span class="text-gray-700">Loading...</span>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal">
        <span class="close" onclick="closeImageModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <!-- Edit Note Modal -->
    <div id="editNoteModal" class="manage-modal">
        <div class="manage-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Edit Note</h3>
                <button onclick="closeEditNoteModal()" class="text-gray-500 hover:text-gray-700">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>
            
            <form onsubmit="updateNote(event)" class="grid grid-cols-1 gap-4">
                <input type="hidden" id="edit-note-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Plant/Tree Name *</label>
                    <input type="text" id="edit-plant-name" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Condition *</label>
                    <textarea id="edit-condition" required rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Recommended Treatment *</label>
                    <textarea id="edit-treatment" required rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                    <select id="edit-status" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="healthy">Healthy</option>
                        <option value="unhealthy">Unhealthy</option>
                        <option value="treated">Treated</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                        Update Note
                    </button>
                    <button type="button" onclick="closeEditNoteModal()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Image Management Modal -->
    <div id="imageManagementModal" class="manage-modal">
        <div class="manage-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Manage Images</h3>
                <button onclick="closeImageManagementModal()" class="text-gray-500 hover:text-gray-700">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>
            
            <div id="image-management-content">
                <!-- This will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Global state
        let customers = [];
        let notes = [];
        let currentTab = 'customers';
        let selectedFiles = [];
        let currentNoteForImages = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomers();
            loadNotes();
        });

        // Tab management
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(tabName + '-tab').classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(tabName + '-tab').classList.add('border-blue-500', 'text-blue-600');

            // Update content
            document.querySelectorAll('[id$="-content"]').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(tabName + '-content').classList.remove('hidden');
            currentTab = tabName;

            // Load data if needed
            if (tabName === 'customers') {
                loadCustomers();
            } else if (tabName === 'notes') {
                loadNotes();
                populateCustomerSelects();
            }
        }

        // Loading state management
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // Image handling
        function previewImages(input) {
            const container = document.getElementById('image-preview-container');
            container.innerHTML = '';
            selectedFiles = Array.from(input.files);

            selectedFiles.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.createElement('div');
                        preview.className = 'image-preview';
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="Preview">
                            <div class="remove-btn" onclick="removeImage(${index})">&times;</div>
                        `;
                        container.appendChild(preview);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function removeImage(index) {
            selectedFiles.splice(index, 1);
            
            // Update file input
            const input = document.getElementById('note-images');
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            input.files = dt.files;
            
            // Refresh preview
            previewImages(input);
        }

        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = src;
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // FIXED: Image Management Modal - Completely rewritten
        function openImageManagementModal(noteId) {
            console.log('Opening image management for note:', noteId);
            
            currentNoteForImages = noteId;
            const modal = document.getElementById('imageManagementModal');
            const content = document.getElementById('image-management-content');
            
            // Find the note
            const note = notes.find(n => n.id === noteId);
            if (!note) {
                console.error('Note not found:', noteId);
                alert('Note not found');
                return;
            }
            
            console.log('Found note:', note);
            
            // Build the content HTML
            let imagesHtml = '';
            if (note.images && note.images.length > 0) {
                imagesHtml = note.images.map(image => `
                    <div class="existing-image">
                        <img src="${image.url}" alt="${image.original_filename}" 
                             onclick="openImageModal('${image.url}')" 
                             title="${image.original_filename}">
                        <div class="delete-btn" onclick="deleteNoteImage('${noteId}', '${image.id}')">&times;</div>
                    </div>
                `).join('');
            } else {
                imagesHtml = '<p class="text-gray-500 text-sm col-span-full">No images uploaded yet</p>';
            }
            
            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-medium text-gray-900 mb-2">Plant: ${note.plant_name}</h4>
                    <p class="text-sm text-gray-600">Customer: ${note.customer_name}</p>
                </div>
                
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3">Current Images (${note.images ? note.images.length : 0})</h5>
                    <div class="existing-images">
                        ${imagesHtml}
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <h5 class="font-medium text-gray-700 mb-3">Add New Images</h5>
                    <input type="file" id="additional-images" multiple accept="image/*" 
                           onchange="previewAdditionalImages(this)"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-3">
                    <div id="additional-image-preview" class="mb-3"></div>
                    <button onclick="uploadAdditionalImages('${noteId}')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Upload Images
                    </button>
                </div>
            `;
            
            console.log('Content set, showing modal');
            modal.style.display = 'block';
        }

        function closeImageManagementModal() {
            document.getElementById('imageManagementModal').style.display = 'none';
            currentNoteForImages = null;
        }

        function previewAdditionalImages(input) {
            const container = document.getElementById('additional-image-preview');
            container.innerHTML = '';
            const files = Array.from(input.files);

            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.createElement('div');
                        preview.className = 'image-preview';
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="Preview">
                            <div class="remove-btn" onclick="removeAdditionalImage(${index})">&times;</div>
                        `;
                        container.appendChild(preview);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function removeAdditionalImage(index) {
            const input = document.getElementById('additional-images');
            const files = Array.from(input.files);
            files.splice(index, 1);
            
            const dt = new DataTransfer();
            files.forEach(file => dt.items.add(file));
            input.files = dt.files;
            
            previewAdditionalImages(input);
        }

        async function uploadAdditionalImages(noteId) {
            const input = document.getElementById('additional-images');
            const files = input.files;
            
            if (!files || files.length === 0) {
                alert('Please select images to upload');
                return;
            }
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('images', file);
            }
            
            try {
                showLoading();
                const response = await fetch(`/api/notes/${noteId}/images`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    
                    // Refresh notes and reopen modal
                    await loadNotes();
                    openImageManagementModal(noteId);
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error uploading images:', error);
                alert('Error uploading images. Please try again.');
            } finally {
                hideLoading();
            }
        }

        async function deleteNoteImage(noteId, imageId) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }
            
            try {
                showLoading();
                const response = await fetch(`/api/notes/${noteId}/images`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image_id: imageId })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    
                    // Refresh notes and reopen modal
                    await loadNotes();
                    openImageManagementModal(noteId);
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('Error deleting image. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // Edit Note Modal Functions
        function openEditNoteModal(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) {
                alert('Note not found');
                return;
            }
            
            document.getElementById('edit-note-id').value = note.id;
            document.getElementById('edit-plant-name').value = note.plant_name;
            document.getElementById('edit-condition').value = note.condition;
            document.getElementById('edit-treatment').value = note.recommended_treatment;
            document.getElementById('edit-status').value = note.status;
            
            document.getElementById('editNoteModal').style.display = 'block';
        }

        function closeEditNoteModal() {
            document.getElementById('editNoteModal').style.display = 'none';
        }

        async function updateNote(event) {
            event.preventDefault();
            
            const noteId = document.getElementById('edit-note-id').value;
            const noteData = {
                plant_name: document.getElementById('edit-plant-name').value,
                condition: document.getElementById('edit-condition').value,
                recommended_treatment: document.getElementById('edit-treatment').value,
                status: document.getElementById('edit-status').value
            };

            try {
                showLoading();
                const response = await fetch(`/api/notes/${noteId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(noteData)
                });

                if (response.ok) {
                    closeEditNoteModal();
                    await loadNotes();
                    alert('Note updated successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error updating note:', error);
                alert('Error updating note. Please try again.');
            } finally {
                hideLoading();
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note? This will also delete all associated images.')) {
                return;
            }
            
            try {
                showLoading();
                const response = await fetch(`/api/notes/${noteId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadNotes();
                    alert('Note deleted successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Error deleting note. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const imageModal = document.getElementById('imageModal');
            const managementModal = document.getElementById('imageManagementModal');
            const editModal = document.getElementById('editNoteModal');
            
            if (event.target === imageModal) {
                imageModal.style.display = 'none';
            }
            if (event.target === managementModal) {
                managementModal.style.display = 'none';
            }
            if (event.target === editModal) {
                editModal.style.display = 'none';
            }
        }

        // Customer management
        async function loadCustomers() {
            try {
                showLoading();
                const response = await fetch('/api/customers');
                customers = await response.json();
                renderCustomers();
            } catch (error) {
                console.error('Error loading customers:', error);
                alert('Error loading customers. Please try again.');
            } finally {
                hideLoading();
            }
        }

        function renderCustomers() {
            const container = document.getElementById('customers-list');
            
            if (customers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg mb-2">No customers found</p>
                        <p>Add your first customer to get started</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = customers.map(customer => `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow duration-200 fade-in">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">${customer.name}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
                                ${customer.email ? `<div><span class="font-medium">Email:</span> ${customer.email}</div>` : ''}
                                ${customer.phone ? `<div><span class="font-medium">Phone:</span> ${customer.phone}</div>` : ''}
                                ${customer.address ? `<div><span class="font-medium">Address:</span> ${customer.address}</div>` : ''}
                            </div>
                            <div class="mt-3 text-xs text-gray-500">
                                Added: ${new Date(customer.date_created).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="viewCustomerNotes('${customer.id}')" 
                                    class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm font-medium transition-colors duration-200">
                                View Notes
                            </button>
                            <button onclick="generateReport('${customer.id}')" 
                                    class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded text-sm font-medium transition-colors duration-200">
                                📄 Report
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showAddCustomerForm() {
            document.getElementById('add-customer-form').classList.remove('hidden');
        }

        function hideAddCustomerForm() {
            document.getElementById('add-customer-form').classList.add('hidden');
            document.getElementById('add-customer-form').querySelector('form').reset();
        }

        async function addCustomer(event) {
            event.preventDefault();
            
            const customerData = {
                name: document.getElementById('customer-name').value,
                email: document.getElementById('customer-email').value || null,
                phone: document.getElementById('customer-phone').value || null,
                address: document.getElementById('customer-address').value || null
            };

            try {
                showLoading();
                const response = await fetch('/api/customers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customerData)
                });

                if (response.ok) {
                    hideAddCustomerForm();
                    await loadCustomers();
                    alert('Customer added successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error adding customer:', error);
                alert('Error adding customer. Please try again.');
            } finally {
                hideLoading();
            }
        }

        function viewCustomerNotes(customerId) {
            showTab('notes');
            document.getElementById('filter-customer').value = customerId;
            filterNotes();
        }

        async function generateReport(customerId) {
            try {
                showLoading();
                
                // Get customer name for the filename
                const customer = customers.find(c => c.id === customerId);
                const customerName = customer ? customer.name : 'Customer';
                
                // Create a temporary link to download the PDF
                const link = document.createElement('a');
                link.href = `/api/customers/${customerId}/report`;
                link.download = `plant_care_report_${customerName.replace(/\s+/g, '_')}.pdf`;
                
                // Trigger the download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                setTimeout(() => {
                    alert(`PDF report for ${customerName} has been generated and downloaded!`);
                }, 500);
                
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Error generating report. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // Notes management
        async function loadNotes() {
            try {
                showLoading();
                const response = await fetch('/api/notes');
                notes = await response.json();
                console.log('Loaded notes:', notes);
                renderNotes();
            } catch (error) {
                console.error('Error loading notes:', error);
                alert('Error loading notes. Please try again.');
            } finally {
                hideLoading();
            }
        }

        function renderNotes(notesToRender = notes) {
            const container = document.getElementById('notes-list');
            
            if (notesToRender.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg mb-2">No notes found</p>
                        <p>Add your first plant care note to get started</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notesToRender.map(note => `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow duration-200 fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h3 class="text-lg font-semibold text-gray-900">${note.plant_name}</h3>
                                <span class="px-3 py-1 rounded-full text-xs font-medium border status-${note.status}">
                                    ${note.status.charAt(0).toUpperCase() + note.status.slice(1)}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-1">Customer: <span class="font-medium">${note.customer_name}</span></p>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${new Date(note.date_created).toLocaleDateString()}
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-1">Condition:</h4>
                            <p class="text-sm text-gray-600">${note.condition}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-1">Recommended Treatment:</h4>
                            <p class="text-sm text-gray-600">${note.recommended_treatment}</p>
                        </div>
                        ${note.images && note.images.length > 0 ? `
                            <div>
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Images (${note.images.length}):</h4>
                                <div class="image-gallery">
                                    ${note.images.map(image => `
                                        <img src="${image.url}" 
                                             alt="${image.original_filename}"
                                             onclick="openImageModal('${image.url}')"
                                             title="${image.original_filename}">
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="note-actions">
                        <button onclick="openEditNoteModal('${note.id}')" 
                                class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm font-medium transition-colors duration-200">
                            ✏️ Edit Note
                        </button>
                        <button onclick="openImageManagementModal('${note.id}')" 
                                class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded text-sm font-medium transition-colors duration-200">
                            📷 Manage Images
                        </button>
                        <button onclick="deleteNote('${note.id}')" 
                                class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm font-medium transition-colors duration-200">
                            🗑️ Delete
                        </button>
                    </div>
                    
                    ${note.date_updated !== note.date_created ? `
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <p class="text-xs text-gray-500">Last updated: ${new Date(note.date_updated).toLocaleDateString()}</p>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function showAddNoteForm() {
            document.getElementById('add-note-form').classList.remove('hidden');
            populateCustomerSelects();
        }

        function hideAddNoteForm() {
            document.getElementById('add-note-form').classList.add('hidden');
            document.getElementById('add-note-form').querySelector('form').reset();
            document.getElementById('image-preview-container').innerHTML = '';
            selectedFiles = [];
        }

        function populateCustomerSelects() {
            const selects = ['note-customer', 'filter-customer'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                
                // Clear existing options (except the first one)
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    select.appendChild(option);
                });
                
                // Restore previous value if it still exists
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        async function addNote(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('customer_id', document.getElementById('note-customer').value);
            formData.append('plant_name', document.getElementById('note-plant-name').value);
            formData.append('condition', document.getElementById('note-condition').value);
            formData.append('recommended_treatment', document.getElementById('note-treatment').value);
            formData.append('status', document.getElementById('note-status').value);
            
            // Add images
            selectedFiles.forEach(file => {
                formData.append('images', file);
            });

            try {
                showLoading();
                const response = await fetch('/api/notes', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    hideAddNoteForm();
                    await loadNotes();
                    alert('Note added successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Error adding note. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // Filtering function
        async function filterNotes() {
            const customerId = document.getElementById('filter-customer').value;
            const status = document.getElementById('filter-status').value;
            
            // If no filters are selected, show all notes
            if (!customerId && !status) {
                renderNotes(notes);
                return;
            }
            
            // Build API URL with proper parameters
            let url = '/api/notes?';
            const params = [];
            
            if (customerId) params.push(`customer_id=${customerId}`);
            if (status) params.push(`status=${status}`);
            
            url += params.join('&');
            
            try {
                showLoading();
                const response = await fetch(url);
                const filteredNotes = await response.json();
                renderNotes(filteredNotes);
            } catch (error) {
                console.error('Error filtering notes:', error);
                alert('Error filtering notes. Please try again.');
                // Fallback to client-side filtering if API fails
                let filtered = notes;
                
                if (customerId) {
                    filtered = filtered.filter(note => note.customer_id === customerId);
                }
                
                if (status) {
                    filtered = filtered.filter(note => note.status === status);
                }
                
                renderNotes(filtered);
            } finally {
                hideLoading();
            }
        }

        function clearFilters() {
            document.getElementById('filter-customer').value = '';
            document.getElementById('filter-status').value = '';
            renderNotes(notes);
        }
    </script>
</body>
</html>